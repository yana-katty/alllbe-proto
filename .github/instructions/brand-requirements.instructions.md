---
applyTo: "backend/src/**"
---

# Brand ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¦ä»¶å®šç¾©: Organizationé…ä¸‹ã®ãƒ–ãƒ©ãƒ³ãƒ‰ç®¡ç†

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€WorkOS Organization é…ä¸‹ã«é…ç½®ã™ã‚‹ã€ŒBrandï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰ï¼‰ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è¦ä»¶ã‚’å®šç¾©ã—ã¾ã™ã€‚

## èƒŒæ™¯ãƒ»å•é¡Œæ„è­˜

### WorkOS Organization ã®åˆ¶ç´„

WorkOS ã§ã¯ **Organization ãŒæœ€ä¸Šä½ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£** ã§ã‚ã‚Šã€ãã‚Œä»¥ä¸‹ã«ç´°åˆ†åŒ–ã™ã‚‹æ§‹é€ ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ãŸã‚ã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ï¼š

1. **Standard vs Enterprise ã®è¨­è¨ˆç ´ç¶»**: 
   - 1ã¤ã®Organizationã§è¤‡æ•°ã®äº‹æ¥­ãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’é‹å–¶ã—ãŸã„å ´åˆã«å¯¾å¿œã§ããªã„
   - ãƒ—ãƒ©ãƒ³é–“ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãŒç¢ºä¿ã§ããªã„

2. **ãƒãƒ«ãƒãƒ–ãƒ©ãƒ³ãƒ‰é‹å–¶ã®å›°é›£**: 
   - ä¼æ¥­ãŒè¤‡æ•°ã®ç‹¬ç«‹ã—ãŸãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»äº‹æ¥­éƒ¨ã‚’æŒã¤å ´åˆã€ãã‚Œãã‚Œã‚’åˆ¥ã®Organizationã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
   - Organizationé–“ã®çµ±åˆç®¡ç†ãŒã§ããªã„

### è§£æ±ºç­–: Brand ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å°å…¥

WorkOS Organization ã® **ä¸‹ä½æ¦‚å¿µã¨ã—ã¦ã€ŒBrandï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰ï¼‰ã€** ã‚’å°å…¥ã—ã€è‡ªç¤¾DBã§ç®¡ç†ã—ã¾ã™ã€‚

```
WorkOS Organization (æœ€ä¸Šä½ - WorkOSç®¡ç†)
  â†“ (1å¯¾1 ã¾ãŸã¯ 1å¯¾å¤šã€ãƒ—ãƒ©ãƒ³ã«ã‚ˆã£ã¦ç•°ãªã‚‹)
Brand (è‡ªç¤¾DBç®¡ç†)
  â†“ (1å¯¾å¤š)
Experience (ä½“é¨“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„)
  â†“ (1å¯¾å¤š)
Booking (äºˆç´„)
```

## ãƒ—ãƒ©ãƒ³è¨­è¨ˆ

### Standard ãƒ—ãƒ©ãƒ³ï¼ˆMVP: Phase 1å®Ÿè£…å¯¾è±¡ï¼‰

**ç‰¹å¾´**: å°è¦æ¨¡äº‹æ¥­è€…å‘ã‘ã€ã‚·ãƒ³ãƒ—ãƒ«ãªé‹å–¶ä½“åˆ¶

- **Brandæ•°**: 1ã¤ã®ã¿ï¼ˆå›ºå®šï¼‰
- **ãƒ¡ãƒ³ãƒãƒ¼æ•°**: æœ€å¤§10äºº
- **SSO**: ä¸è¦ï¼ˆEmail/Passwordãƒ­ã‚°ã‚¤ãƒ³ï¼‰
- **ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™**: ãªã—
- **ç”¨é€”**: å€‹äººã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã€å°è¦æ¨¡ãƒãƒ¼ãƒ ã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—

**åˆ¶ç´„**:
- Organizationä½œæˆæ™‚ã«è‡ªå‹•ã§1ã¤ã®BrandãŒä½œæˆã•ã‚Œã‚‹
- è¿½åŠ ã®Brandã¯ä½œæˆä¸å¯ï¼ˆUIä¸Šã§ã‚‚åˆ¶é™ï¼‰
- Brandå‰Šé™¤ã¯ä¸å¯ï¼ˆOrganizationå‰Šé™¤æ™‚ã«é€£å‹•å‰Šé™¤ï¼‰

### Enterprise ãƒ—ãƒ©ãƒ³ï¼ˆPhase 2å®Ÿè£…äºˆå®šï¼‰

**ç‰¹å¾´**: å¤§ä¼æ¥­å‘ã‘ã€è¤‡æ•°ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»æ‹ ç‚¹ã®çµ±åˆç®¡ç†

- **Brandæ•°**: æœ€å¤§100å€‹
- **ãƒ¡ãƒ³ãƒãƒ¼æ•°**: ç„¡åˆ¶é™ï¼ˆã¾ãŸã¯é«˜ã„ä¸Šé™ã€ä¾‹: 1,000äººï¼‰
- **SSO**: å¿…é ˆï¼ˆWorkOS SSOçµ±åˆï¼‰
- **ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™**: æœ‰åŠ¹åŒ–å¯èƒ½
- **ç”¨é€”**: è¤‡æ•°ãƒ–ãƒ©ãƒ³ãƒ‰é‹å–¶ä¼æ¥­ã€å¤šæ‹ ç‚¹å±•é–‹ä¼æ¥­ã€å¤§è¦æ¨¡çµ„ç¹”

**æ©Ÿèƒ½**:
- Brandã®è‡ªç”±ãªä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- Brandé–“ã®çµ±åˆãƒ¬ãƒãƒ¼ãƒˆãƒ»åˆ†æ
- Brandåˆ¥ã®æ¨©é™ç®¡ç†ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- SSOçµŒç”±ã§ã®å³æ ¼ãªå¾“æ¥­å“¡ç®¡ç†

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ

### Brand ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ä½œæˆï¼‰

```typescript
export const brands = pgTable('brands', {
    id: uuid('id').primaryKey().defaultRandom(),
    
    // WorkOS Organization ã¸ã®å‚ç…§
    organizationId: varchar('organization_id', { length: 255 })
        .notNull()
        .references(() => organizations.id, { onDelete: 'cascade' }),
    
    // BrandåŸºæœ¬æƒ…å ±
    name: varchar('name', { length: 255 }).notNull(),
    description: text('description'),
    logoUrl: text('logo_url'),
    websiteUrl: text('website_url'),
    
    // ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯ç”¨
    // Standard: isDefault=true ã®BrandãŒ1ã¤ã ã‘å­˜åœ¨
    // Enterprise: è¤‡æ•°ã®Brandã‚’ä½œæˆå¯èƒ½
    isDefault: boolean('is_default').notNull().default(false),
    
    // çŠ¶æ…‹ç®¡ç†
    isActive: boolean('is_active').notNull().default(true),
    
    createdAt: timestamp('created_at').notNull().defaultNow(),
    updatedAt: timestamp('updated_at').notNull().defaultNow(),
}, (table) => ({
    // Organizationåˆ¥ã®Brandæ¤œç´¢ç”¨
    organizationIdIdx: index('brands_organization_id_idx').on(table.organizationId),
    // Standardãƒ—ãƒ©ãƒ³ã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚§ãƒƒã‚¯ç”¨
    orgDefaultIdx: index('brands_org_default_idx').on(table.organizationId, table.isDefault),
}));
```

### Experience ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

**å¤‰æ›´å‰**:
```typescript
organizationId: varchar('organization_id', { length: 255 })
    .notNull()
    .references(() => organizations.id, { onDelete: 'cascade' }),
```

**å¤‰æ›´å¾Œ**:
```typescript
brandId: uuid('brand_id')
    .notNull()
    .references(() => brands.id, { onDelete: 'cascade' }),
```

**å½±éŸ¿ç¯„å›²**:
- `experiences` ãƒ†ãƒ¼ãƒ–ãƒ«: `organization_id` â†’ `brand_id`
- `experienceAssets` ãƒ†ãƒ¼ãƒ–ãƒ«: Experienceã«ç´ã¥ããŸã‚å¤‰æ›´ãªã—ï¼ˆé–“æ¥çš„ã«Brandã«ç´ã¥ãï¼‰
- `bookings` ãƒ†ãƒ¼ãƒ–ãƒ«: Experienceã«ç´ã¥ããŸã‚å¤‰æ›´ãªã—

## ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«

### Brandä½œæˆãƒ«ãƒ¼ãƒ«

#### Standard ãƒ—ãƒ©ãƒ³
1. **Organizationä½œæˆæ™‚ã«è‡ªå‹•ä½œæˆ**: 
   - Organizationä½œæˆWorkflowã§ã€è‡ªå‹•çš„ã«1ã¤ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandï¼ˆ`isDefault: true`ï¼‰ã‚’ä½œæˆ
   - Brandåã¯ Organizationåã‚’åˆæœŸå€¤ã¨ã—ã¦ä½¿ç”¨ï¼ˆå¾Œã§å¤‰æ›´å¯èƒ½ï¼‰

2. **è¿½åŠ ä½œæˆã®ç¦æ­¢**: 
   - UIä¸Šã§Brandä½œæˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
   - APIå±¤ã§ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ï¼ˆ`BRAND_LIMIT_REACHED` ã‚¨ãƒ©ãƒ¼ï¼‰

3. **å‰Šé™¤ã®ç¦æ­¢**: 
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandã¯å‰Šé™¤ä¸å¯
   - Organizationå‰Šé™¤æ™‚ã®ã¿é€£å‹•å‰Šé™¤

#### Enterprise ãƒ—ãƒ©ãƒ³
1. **è¤‡æ•°Brandä½œæˆ**: 
   - æœ€å¤§100å€‹ã¾ã§Brandã‚’ä½œæˆå¯èƒ½
   - 100å€‹ã«é”ã—ãŸå ´åˆã¯ `BRAND_LIMIT_REACHED` ã‚¨ãƒ©ãƒ¼

2. **Brandå‰Šé™¤**: 
   - Experienceãƒ»BookingãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿å‰Šé™¤å¯èƒ½
   - Experienceç­‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ `BRAND_HAS_DEPENDENCIES` ã‚¨ãƒ©ãƒ¼

### Brandåˆ¶é™ã®ãƒã‚§ãƒƒã‚¯

```typescript
// Brandã®åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
export async function canCreateBrand(
    organizationId: string, 
    planType: 'standard' | 'enterprise'
): Promise<boolean> {
    const existingBrands = await db.select()
        .from(brands)
        .where(eq(brands.organizationId, organizationId));
    
    if (planType === 'standard') {
        // Standardã¯1ã¤ã¾ã§
        return existingBrands.length === 0;
    } else {
        // Enterpriseã¯100å€‹ã¾ã§
        return existingBrands.length < 100;
    }
}
```

### ãƒ¡ãƒ³ãƒãƒ¼åˆ¶é™ã®ãƒã‚§ãƒƒã‚¯ï¼ˆWorkOSå´ï¼‰

```typescript
// Organizationã®ãƒ¡ãƒ³ãƒãƒ¼æ•°åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
export async function canInviteMember(
    organizationId: string, 
    planType: 'standard' | 'enterprise'
): Promise<boolean> {
    const members = await workos.userManagement.listOrganizationMemberships({
        organizationId,
    });
    
    if (planType === 'standard') {
        // Standardã¯10äººã¾ã§
        return members.data.length < 10;
    } else {
        // Enterpriseã¯ç„¡åˆ¶é™ï¼ˆã¾ãŸã¯1000äººï¼‰
        return members.data.length < 1000;
    }
}
```

## æ¨©é™ç®¡ç†

### Brandå˜ä½ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

Organizationé…ä¸‹ã®ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€**ç‰¹å®šã®Brandã«å¯¾ã™ã‚‹æ¨©é™** ã‚’æŒã¡ã¾ã™ï¼š

```typescript
export const brandMemberships = pgTable('brand_memberships', {
    id: uuid('id').primaryKey().defaultRandom(),
    
    brandId: uuid('brand_id')
        .notNull()
        .references(() => brands.id, { onDelete: 'cascade' }),
    
    // WorkOS User ID (Organization Member)
    workosUserId: varchar('workos_user_id', { length: 255 }).notNull(),
    
    // Brandå†…ã§ã®å½¹å‰²
    role: varchar('role', { length: 50 }).notNull(), // 'admin', 'manager', 'viewer'
    
    createdAt: timestamp('created_at').notNull().defaultNow(),
    updatedAt: timestamp('updated_at').notNull().defaultNow(),
}, (table) => ({
    brandUserIdx: index('brand_memberships_brand_user_idx')
        .on(table.brandId, table.workosUserId),
}));
```

**å½¹å‰²å®šç¾©**:
- **admin**: Brandè¨­å®šã®ç·¨é›†ã€ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã€Experienceç®¡ç†
- **manager**: Experienceç®¡ç†ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†
- **viewer**: é–²è¦§ã®ã¿

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥

### Phase 1 â†’ Phase 1.5ï¼ˆBrandå°å…¥ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: Brand ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
```sql
-- Brand ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE brands (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id VARCHAR(255) NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    logo_url TEXT,
    website_url TEXT,
    is_default BOOLEAN NOT NULL DEFAULT FALSE,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX brands_organization_id_idx ON brands(organization_id);
CREATE INDEX brands_org_default_idx ON brands(organization_id, is_default);
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: æ—¢å­˜Organizationã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandã‚’ä½œæˆ
```sql
-- æ—¢å­˜ã®å…¨Organizationã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandã‚’ä½œæˆ
INSERT INTO brands (organization_id, name, is_default, is_active)
SELECT 
    id, 
    'Default Brand', -- åˆæœŸå€¤ï¼ˆå¾Œã§å¤‰æ›´å¯èƒ½ï¼‰
    TRUE,
    TRUE
FROM organizations;
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: Experience ãƒ†ãƒ¼ãƒ–ãƒ«ã« brand_id ã‚«ãƒ©ãƒ è¿½åŠ 
```sql
-- brand_id ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆNULLè¨±å¯ï¼‰
ALTER TABLE experiences ADD COLUMN brand_id UUID REFERENCES brands(id) ON DELETE CASCADE;

-- æ—¢å­˜ã®Experienceã«å¯¾ã—ã¦ã€Organizationã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒ‰ã‚’é–¢é€£ä»˜ã‘
UPDATE experiences e
SET brand_id = (
    SELECT b.id
    FROM brands b
    WHERE b.organization_id = e.organization_id
    AND b.is_default = TRUE
    LIMIT 1
);

-- brand_id ã‚’ NOT NULL ã«å¤‰æ›´
ALTER TABLE experiences ALTER COLUMN brand_id SET NOT NULL;

-- organization_id ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤
ALTER TABLE experiences DROP COLUMN organization_id;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX experiences_brand_id_idx ON experiences(brand_id);
```

## APIè¨­è¨ˆ

### Brandç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆtRPCï¼‰

```typescript
// backend/src/trpc/brand.ts
export const brandRouter = router({
    // Brandä¸€è¦§å–å¾—ï¼ˆOrganizationå†…ï¼‰
    list: protectedProcedure
        .input(z.object({ organizationId: z.string() }))
        .query(async ({ input }) => {
            // WorkflowçµŒç”±ã§Brandä¸€è¦§å–å¾—
        }),
    
    // Brandä½œæˆï¼ˆEnterpriseãƒ—ãƒ©ãƒ³ã®ã¿ï¼‰
    create: protectedProcedure
        .input(z.object({
            organizationId: z.string(),
            name: z.string(),
            description: z.string().optional(),
        }))
        .mutation(async ({ input }) => {
            // ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯ â†’ WorkflowçµŒç”±ã§ä½œæˆ
        }),
    
    // Brandæ›´æ–°
    update: protectedProcedure
        .input(z.object({
            brandId: z.string(),
            name: z.string().optional(),
            description: z.string().optional(),
        }))
        .mutation(async ({ input }) => {
            // WorkflowçµŒç”±ã§æ›´æ–°
        }),
    
    // Brandå‰Šé™¤ï¼ˆEnterpriseãƒ—ãƒ©ãƒ³ã®ã¿ã€ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ï¼‰
    delete: protectedProcedure
        .input(z.object({ brandId: z.string() }))
        .mutation(async ({ input }) => {
            // ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ â†’ WorkflowçµŒç”±ã§å‰Šé™¤
        }),
});
```

## å®Ÿè£…ã®å„ªå…ˆé †ä½

### Phase 1.5: Brandå°å…¥ - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´ç†ï¼ˆå®Œäº†âœ…ï¼‰
- [x] Brandè¦ä»¶å®šç¾©ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
- [x] auth.instructions.md æ›´æ–°ï¼ˆWorkspace â†’ Brandï¼‰
- [x] business-requirements.instructions.md æ›´æ–°
- [x] database.instructions.md æ›´æ–°
- [x] schema.ts ã¸ã®Brandãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

### Phase 1.5: Brandå°å…¥ - å®Ÿè£…ä½œæ¥­ï¼ˆæ¬¡ã®ã‚¿ã‚¹ã‚¯ğŸš€ï¼‰

#### 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã¨DBç¢ºèª
```bash
cd backend
npm run db:migrate
# ã¾ãŸã¯
npm run db:push  # é–‹ç™ºç’°å¢ƒã®å ´åˆ
```

**ç¢ºèªäº‹é …**:
- [ ] `brands` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [ ] æ—¢å­˜ã® `organizations` ã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [ ] `experiences.brand_id` ã‚«ãƒ©ãƒ ãŒè¿½åŠ ã•ã‚Œã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãç´ã¥ã„ã¦ã„ã‚‹ã“ã¨
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨

#### 2. Brand Activity å®Ÿè£…ï¼ˆbackend/src/activities/db/models/brand.tsï¼‰
```typescript
// ä»¥ä¸‹ã®é–¢æ•°ã‚’å®Ÿè£…:
// - insertBrand(db: Database): InsertBrand
// - findBrandById(db: Database): FindBrandById
// - findBrandsByOrganizationId(db: Database): FindBrandsByOrganizationId
// - findDefaultBrandByOrganizationId(db: Database): FindDefaultBrandByOrganizationId
// - updateBrand(db: Database): UpdateBrand
// - deleteBrand(db: Database): DeleteBrand
// - countBrandsByOrganizationId(db: Database): CountBrandsByOrganizationId
```

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
- [ ] `BrandErrorType` enum ã®å®šç¾©ï¼ˆNOT_FOUND, ALREADY_EXISTS, LIMIT_REACHED, HAS_DEPENDENCIES, etc.ï¼‰
- [ ] `createBrandError` ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°ã®å®Ÿè£…
- [ ] ApplicationFailure ã«ã‚ˆã‚‹çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†

#### 3. Brand Actions å®Ÿè£…ï¼ˆbackend/src/actions/brand.tsï¼‰
```typescript
// ä»¥ä¸‹ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè£…:
// - canCreateBrand(): ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆStandard: 1, Enterprise: 100ï¼‰
// - createBrand(): Brandä½œæˆï¼ˆåˆ¶é™ãƒã‚§ãƒƒã‚¯å«ã‚€ï¼‰
// - getBrandById(): Brandå–å¾—
// - listBrandsByOrganization(): Organizationé…ä¸‹ã®Brandä¸€è¦§
// - updateBrand(): Brandæ›´æ–°
// - deleteBrand(): Brandå‰Šé™¤ï¼ˆä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯å«ã‚€ï¼‰
```

#### 4. Brand Workflow å®Ÿè£…ï¼ˆbackend/src/workflows/brand.tsï¼‰
```typescript
// ä»¥ä¸‹ã®Workflowã‚’å®Ÿè£…:
// - createBrandWorkflow(): Brandä½œæˆï¼ˆSAGAãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
// - updateBrandWorkflow(): Brandæ›´æ–°
// - deleteBrandWorkflow(): Brandå‰Šé™¤ï¼ˆExperienceç­‰ã®ãƒã‚§ãƒƒã‚¯ï¼‰
```

**é‡è¦**: Organizationä½œæˆWorkflowã‚‚æ›´æ–°ãŒå¿…è¦
- `backend/src/workflows/organization.ts` ã® `createOrganizationWorkflow` å†…ã§ã€
  Organizationä½œæˆå¾Œã«è‡ªå‹•ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandã‚’ä½œæˆã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 

#### 5. Brand tRPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…ï¼ˆbackend/src/trpc/brand.tsï¼‰
```typescript
export const brandRouter = router({
  list: protectedProcedure
    .input(z.object({ organizationId: z.string() }))
    .query(async ({ input }) => { /* ... */ }),
  
  create: protectedProcedure  // Enterpriseãƒ—ãƒ©ãƒ³ã®ã¿
    .input(z.object({ organizationId: z.string(), name: z.string(), ... }))
    .mutation(async ({ input }) => { /* ... */ }),
  
  update: protectedProcedure
    .input(z.object({ brandId: z.string(), name: z.string().optional(), ... }))
    .mutation(async ({ input }) => { /* ... */ }),
  
  delete: protectedProcedure  // Enterpriseãƒ—ãƒ©ãƒ³ã®ã¿
    .input(z.object({ brandId: z.string() }))
    .mutation(async ({ input }) => { /* ... */ }),
});
```

#### 6. æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°
- [ ] `backend/src/activities/db/models/experience.ts`: `organizationId` â†’ `brandId` ã«å¤‰æ›´
- [ ] `backend/src/actions/experience.ts`: BrandçµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã«å¤‰æ›´
- [ ] `backend/src/workflows/experience.ts`: Brandæ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã®è¿½åŠ 
- [ ] `backend/src/trpc/experience.ts`: Brand IDã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´

#### 7. ãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- [ ] `backend/src/activities/db/models/brand.test.ts`: Activityå˜ä½“ãƒ†ã‚¹ãƒˆ
- [ ] `backend/src/actions/brand.test.ts`: Actionså˜ä½“ãƒ†ã‚¹ãƒˆ
- [ ] `backend/src/workflows/brand.test.ts`: Workflowçµ±åˆãƒ†ã‚¹ãƒˆ

### Phase 2: Enterpriseæ©Ÿèƒ½ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
- [ ] è¤‡æ•°Brandä½œæˆUI
- [ ] Brandé–“ã®çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ
- [ ] Brandåˆ¥æ¨©é™ç®¡ç†ï¼ˆbrand_memberships ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- [ ] SSOçµ±åˆå¼·åŒ–

## å‚è€ƒè³‡æ–™

- [WorkOS Organizations Documentation](https://workos.com/docs/user-management/organizations)
- [Model your B2B SaaS with Organizations - WorkOS Blog](https://workos.com/blog/model-your-b2b-saas-with-organizations)
- `auth.instructions.md`: èªè¨¼ãƒ»Organizationç®¡ç†ã®å…¨ä½“è¨­è¨ˆ
- `business-requirements.instructions.md`: ãƒ“ã‚¸ãƒã‚¹è¦ä»¶å…¨ä½“

## ã¾ã¨ã‚

**Brand ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å°å…¥ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã‚’å®Ÿç¾**:

1. **æŸ”è»Ÿãªãƒ—ãƒ©ãƒ³è¨­è¨ˆ**: Standardï¼ˆ1 Brandï¼‰â†’ Enterpriseï¼ˆ100 Brandsï¼‰ã¸ã®è‡ªç„¶ãªæ‹¡å¼µ
2. **WorkOSåˆ¶ç´„ã®å›é¿**: Organizationé…ä¸‹ã§ã®ç´°åˆ†åŒ–æ§‹é€ ã‚’è‡ªç¤¾DBå´ã§å®Ÿç¾
3. **ãƒãƒ«ãƒãƒ–ãƒ©ãƒ³ãƒ‰é‹å–¶**: å¤§ä¼æ¥­ã®è¤‡æ•°ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»äº‹æ¥­éƒ¨ç®¡ç†ã«å¯¾å¿œ
4. **æ®µéšçš„å®Ÿè£…**: Phase 1ã§ã¯Standardãƒ—ãƒ©ãƒ³ï¼ˆ1 Brandï¼‰ã®ã¿ã€Phase 2ã§Enterpriseæ©Ÿèƒ½ã‚’è¿½åŠ 

## æ¬¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ã®å¼•ãç¶™ãäº‹é …

### ğŸ“‹ å®Ÿè£…å®Œäº†ï¼ˆ2025å¹´10æœˆ7æ—¥ï¼‰

**âœ… Phase 1.5: Brandå°å…¥ - å®Œå…¨å®Ÿè£…æ¸ˆã¿**:

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤**:
   - âœ… `brands` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆschema.ts + ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
   - âœ… `experiences.brandId` ã¸ã®ç§»è¡Œï¼ˆorganizationId â†’ brandIdï¼‰
   - âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®è¨­å®š

2. **Activityå±¤**ï¼ˆbackend/src/activities/db/models/brand.tsï¼‰:
   - âœ… 7ã¤ã®Brand Activityé–¢æ•°å®Ÿè£…
   - âœ… ApplicationFailureãƒ™ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   - âœ… 16ãƒ†ã‚¹ãƒˆï¼ˆå…¨é€šéï¼‰

3. **Actionså±¤**ï¼ˆbackend/src/actions/brand.tsï¼‰:
   - âœ… 9ã¤ã®Brand Actionså®Ÿè£…
   - âœ… ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆStandard: 1å€‹ã€Enterprise: 100å€‹ï¼‰
   - âœ… 22ãƒ†ã‚¹ãƒˆï¼ˆå…¨é€šéï¼‰

4. **Workflowå±¤**ï¼ˆbackend/src/workflows/brand.ts + organization.tsï¼‰:
   - âœ… Brandä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤Workflowï¼ˆSAGAãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
   - âœ… Organizationä½œæˆæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandè‡ªå‹•ä½œæˆ
   - âœ… è£œå„Ÿå‡¦ç†ã®å®Œå…¨å®Ÿè£…

5. **tRPC APIå±¤**ï¼ˆbackend/src/trpc/brand.tsï¼‰:
   - âœ… 6ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆlist/getById/getDefault/create/update/deleteï¼‰
   - âœ… Temporal Workflowã¨ã®çµ±åˆ
   - âœ… 1ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆå…¨é€šéï¼‰

6. **Experienceå±¤ã®Brandç§»è¡Œ**:
   - âœ… Experience Activityå±¤ã§ã®brandIdåˆ©ç”¨
   - âœ… æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°å®Œäº†

7. **ãƒ†ã‚¹ãƒˆ**:
   - âœ… åˆè¨ˆ46ãƒ†ã‚¹ãƒˆå…¨é€šéï¼ˆBrand: 39, Organization: 7ï¼‰
   - âœ… ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ç¢ºç«‹ã¨æ–‡æ›¸åŒ–

**Phase 1.5ã¯å®Œå…¨ã«å®Œäº†ã—ã¦ã„ã¾ã™ã€‚æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã¸é€²ã‚€æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚**

### ğŸ¯ å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ

#### Standard ãƒ—ãƒ©ãƒ³ï¼ˆPhase 1ï¼‰ã®åˆ¶ç´„
```typescript
// Brandæ•°åˆ¶é™: 1ã¤ã®ã¿ï¼ˆOrganizationä½œæˆæ™‚ã«è‡ªå‹•ä½œæˆï¼‰
// - isDefault: true ã®BrandãŒ1ã¤ã ã‘å­˜åœ¨
// - UIä¸Šã§Brandä½œæˆãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º
// - APIå±¤ã§ã‚‚è¿½åŠ ä½œæˆã‚’æ‹’å¦

// ãƒ¡ãƒ³ãƒãƒ¼æ•°åˆ¶é™: 10äººã¾ã§ï¼ˆWorkOSå´ã§ãƒã‚§ãƒƒã‚¯ï¼‰
export async function canInviteMember(
    organizationId: string, 
    planType: 'standard' | 'enterprise'
): Promise<boolean> {
    const members = await workos.userManagement.listOrganizationMemberships({
        organizationId,
    });
    return planType === 'standard' 
        ? members.data.length < 10 
        : members.data.length < 1000;
}
```

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³
```typescript
// backend/src/activities/db/models/brand.ts
export enum BrandErrorType {
    NOT_FOUND = 'BRAND_NOT_FOUND',
    ALREADY_EXISTS = 'BRAND_ALREADY_EXISTS',
    LIMIT_REACHED = 'BRAND_LIMIT_REACHED',
    HAS_DEPENDENCIES = 'BRAND_HAS_DEPENDENCIES',
    INVALID_INPUT = 'BRAND_INVALID_INPUT',
    DATABASE_ERROR = 'BRAND_DATABASE_ERROR',
}

export const createBrandError = (info: BrandErrorInfo): ApplicationFailure => {
    return ApplicationFailure.create({
        message: info.message,
        type: info.type,
        details: info.details ? [info.details] : undefined,
        nonRetryable: info.nonRetryable ?? true,
    });
};
```

#### Organizationä½œæˆæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandä½œæˆ
```typescript
// backend/src/workflows/organization.ts
export async function createOrganizationWorkflow(
    input: CreateOrganizationInput
): Promise<Organization> {
    const compensations: Compensation[] = [];
    
    try {
        // Step 1: WorkOS Organization ä½œæˆ
        const workosOrg = await createWorkosOrganizationActivity({ ... });
        compensations.unshift({ ... });

        // Step 2: DB ã« Organization ä¿å­˜
        const org = await insertOrganizationActivity({ id: workosOrg.id });
        compensations.unshift({ ... });

        // Step 3: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandä½œæˆï¼ˆæ–°è¦è¿½åŠ ï¼‰â­
        const defaultBrand = await insertBrandActivity({
            organizationId: org.id,
            name: 'Default Brand', // ã¾ãŸã¯ Organizationåã‚’ä½¿ç”¨
            isDefault: true,
            isActive: true,
        });
        compensations.unshift({
            message: 'reversing default brand creation',
            fn: () => deleteBrandActivity(defaultBrand.id),
        });

        return org;
    } catch (error) {
        await compensate(compensations);
        throw error;
    }
}
```

### ğŸ“š å‚è€ƒè³‡æ–™

**å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³å‚è€ƒ**:
- `backend/src/activities/db/models/organization.ts`: åŸºæœ¬çš„ãªActivityå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
- `backend/src/actions/organization.ts`: Actionså±¤ã®ä¾å­˜æ³¨å…¥ãƒ‘ã‚¿ãƒ¼ãƒ³
- `backend/src/workflows/organization.ts`: Workflow + SAGAãƒ‘ã‚¿ãƒ¼ãƒ³
- `backend/src/trpc/organization.ts`: tRPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…

**è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- `.github/instructions/activities.instructions.md`: Activityå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- `.github/instructions/actions.instructions.md`: Actionså®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- `.github/instructions/workflows.instructions.md`: Workflowå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- `.github/instructions/trpc.instructions.md`: tRPCå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- `.github/instructions/testing.instructions.md`: ãƒ†ã‚¹ãƒˆå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### âš ï¸ æ³¨æ„äº‹é …

1. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã®ç¢ºèªå¿…é ˆ**:
   - æ—¢å­˜ã®å…¨Organizationã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹
   - æ—¢å­˜ã®ExperienceãŒBrandã«æ­£ã—ãç´ã¥ã„ã¦ã„ã‚‹ã‹

2. **å¾Œæ–¹äº’æ›æ€§**:
   - æ—¢å­˜ã®Experienceé–¢é€£ã®APIã¯ã€BrandçµŒç”±ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
   - Organization IDã‹ã‚‰Brand IDã¸ã®å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹

3. **ãƒ—ãƒ©ãƒ³åˆ¶é™ã®å®Ÿè£…**:
   - Standard ãƒ—ãƒ©ãƒ³ã§ã¯ UI ä¸Šã§ Brand ä½œæˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
   - APIå±¤ã§ã‚‚ `BRAND_LIMIT_REACHED` ã‚¨ãƒ©ãƒ¼ã§æ‹’å¦
   - Enterprise ãƒ—ãƒ©ãƒ³ã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒ‘ã‚¹ã‚’è€ƒæ…®

4. **Brandå‰Šé™¤æ™‚ã®ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯**:
   - Experienceã€Bookingç­‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandï¼ˆisDefault: trueï¼‰ã¯å‰Šé™¤ä¸å¯

### ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

```typescript
// å„ªå…ˆçš„ã«ãƒ†ã‚¹ãƒˆã™ã¹ãé …ç›®:
// 1. Brandä½œæˆæ™‚ã®ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆStandard: 1å€‹ã¾ã§ï¼‰
// 2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBrandã®è‡ªå‹•ä½œæˆï¼ˆOrganizationä½œæˆæ™‚ï¼‰
// 3. Brandå‰Šé™¤æ™‚ã®ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ï¼ˆExperienceå­˜åœ¨æ™‚ã¯å‰Šé™¤ä¸å¯ï¼‰
// 4. Experience â†’ Brand â†’ Organization ã®å‚ç…§æ•´åˆæ€§
// 5. ApplicationFailure ã«ã‚ˆã‚‹é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```

å®Ÿè£…ã‚’é–‹å§‹ã™ã‚‹éš›ã¯ã€ä¸Šè¨˜ã®ã€ŒPhase 1.5: Brandå°å…¥ - å®Ÿè£…ä½œæ¥­ã€ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å¾“ã£ã¦é€²ã‚ã¦ãã ã•ã„ã€‚
